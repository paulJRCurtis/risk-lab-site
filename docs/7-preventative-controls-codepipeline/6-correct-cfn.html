<!doctype html><html class=no-js lang=en-us prefix="og: https://ogp.me/ns# fb: https://ogp.me/ns/fb#"><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta property="og:title" content="Risk & Compliance Labs"><meta property="og:type" content="website"><meta property="og:url" content><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=generator content="Hugo 0.80.0"><meta name=description content="Hands on labs for those interested in risk & assurance, and compliance."><meta name=author content="Amazon AWS"><link rel="shortcut icon" href=https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico type=image/ico><link rel=icon href=https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico type=image/ico><title>Review code pipeline :: Risk & Compliance Labs</title><link href=../css/nucleus.css rel=stylesheet><link href=../css/fontawesome-all.min.css rel=stylesheet><link href=../css/hybrid.css rel=stylesheet><link href=../css/featherlight.min.css rel=stylesheet><link href=../css/perfect-scrollbar.min.css rel=stylesheet><link href=../css/auto-complete.css rel=stylesheet><link href=../css/atom-one-dark-reasonable.css rel=stylesheet><link href=../css/theme.css rel=stylesheet><link href=../css/hugo-theme.css rel=stylesheet><link href=../css/theme-aws.css rel=stylesheet><script src=../js/jquery-3.3.1.min.js></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=../7-preventative-controls-codepipeline/6-correct-cfn.html><nav id=sidebar><div id=header-wrapper><div id=header><div><a href=../ title="Go home"><img style=vertical-align:middle src=../images/logo.png height=70px></a></div></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label><input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=../js/lunr.min.js></script><script type=text/javascript src=../js/auto-complete.js></script><script type=text/javascript>var baseurl="";</script><script type=text/javascript src=../js/search.js></script></div><div class=highlightable><ul class=topics><li data-nav-id=/1-start-workshop.html title="Start the Workshop" class=dd-item><a href=../1-start-workshop.html><b></b>Start the Workshop</a><ul><li data-nav-id=/1-start-workshop/on-your-own.html title="In your own account" class=dd-item><a href=../1-start-workshop/on-your-own.html><b></b>On your own</a><ul><li data-nav-id=/1-start-workshop/on-your-own/create-an-aws-account.html title="Create an AWS Account" class=dd-item><a href=../1-start-workshop/on-your-own/create-an-aws-account.html>Create an AWS Account</a></li></ul></li><li data-nav-id=/1-start-workshop/at-an-aws-event.html title="At an AWS Event" class=dd-item><a href=../1-start-workshop/at-an-aws-event.html>At an AWS Event</a><ul><li data-nav-id=/1-start-workshop/at-an-aws-event/aws-workshop-portal.html title="AWS Workshop Portal" class=dd-item><a href=../1-start-workshop/at-an-aws-event/aws-workshop-portal.html><b></b>AWS Workshop Portal</a></li></ul></li></ul></li><li data-nav-id=/2-know-the-console.html title="Getting to Know the Console" class=dd-item><a href=../2-know-the-console.html>Getting to Know the Console</a></li><li data-nav-id=/3-aws-compliance-reports.html title="Accessing AWS Compliance Reports" class=dd-item><a href=../3-aws-compliance-reports.html>AWS Compliance Reports</a><ul><li data-nav-id=/3-aws-compliance-reports/1-intro.html title=Introduction class=dd-item><a href=../3-aws-compliance-reports/1-intro.html><b>1. </b>Introduction</a></li><li data-nav-id=/3-aws-compliance-reports/2-access-a-report.html title="Access a report" class=dd-item><a href=../3-aws-compliance-reports/2-access-a-report.html><b>2. </b>Access a report</a></li><li data-nav-id=/3-aws-compliance-reports/3-interpret-results.html title="Interpreting the results" class=dd-item><a href=../3-aws-compliance-reports/3-interpret-results.html><b>3. </b>Interpreting the results</a></li><li data-nav-id=/3-aws-compliance-reports/4-shared-responsibility.html title="Deep Dive: Shared Responsibility" class=dd-item><a href=../3-aws-compliance-reports/4-shared-responsibility.html><b>4. </b>Deep Dive: Shared Responsibility</a></li></ul></li><li data-nav-id=/4-detective-controls-config.html title="Detective Controls with Config" class=dd-item><a href=../4-detective-controls-config.html>Detective Controls with Config</a><ul><li data-nav-id=/4-detective-controls-config/1-intro.html title=Introduction class=dd-item><a href=../4-detective-controls-config/1-intro.html><b>1. </b>Introduction</a></li><li data-nav-id=/4-detective-controls-config/2-env-setup.html title=Set-up class=dd-item><a href=../4-detective-controls-config/2-env-setup.html><b>2. </b>Set-up</a></li><li data-nav-id=/4-detective-controls-config/3-config-setup.html title="Enable AWS Config" class=dd-item><a href=../4-detective-controls-config/3-config-setup.html><b>3. </b>Enable AWS Config</a></li><li data-nav-id=/4-detective-controls-config/4-add-rules.html title="Add Managed Config Rules" class=dd-item><a href=../4-detective-controls-config/4-add-rules.html><b>4. </b>Add Managed Config Rules</a></li><li data-nav-id=/4-detective-controls-config/5-dashboard.html title="Review Dashboard" class=dd-item><a href=../4-detective-controls-config/5-dashboard.html><b>5. </b>Review Dashboard</a></li><li data-nav-id=/4-detective-controls-config/6-rule-scope.html title="Rule Scope" class=dd-item><a href=../4-detective-controls-config/6-rule-scope.html><b>6. </b>Rule Scope</a></li><li data-nav-id=/4-detective-controls-config/7-remediate.html title="Auto Remediate" class=dd-item><a href=../4-detective-controls-config/7-remediate.html><b>7. </b>Auto Remediate</a></li><li data-nav-id=/4-detective-controls-config/8-timelines.html title="Explore Timelines" class=dd-item><a href=../4-detective-controls-config/8-timelines.html><b>8. </b>Explore Timelines</a></li><li data-nav-id=/4-detective-controls-config/9-clean-up.html title="Clean up" class=dd-item><a href=../4-detective-controls-config/9-clean-up.html><b>9. </b>Clean up</a></li></ul></li><li data-nav-id=/6-patching-controls-ssm.html title="Patching Controls with Systems Manager" class=dd-item><a href=../6-patching-controls-ssm.html>Patching Controls with Systems Manager</a><ul><li data-nav-id=/6-patching-controls-ssm/1-intro.html title=Introduction class=dd-item><a href=../6-patching-controls-ssm/1-intro.html><b>1. </b>Introduction</a></li><li data-nav-id=/6-patching-controls-ssm/2-env-setup.html title=Set-up class=dd-item><a href=../6-patching-controls-ssm/2-env-setup.html><b>2. </b>Set-up</a></li><li data-nav-id=/6-patching-controls-ssm/3-current-os.html title="Determine the current OS versions" class=dd-item><a href=../6-patching-controls-ssm/3-current-os.html><b>3. </b>Determine the current OS versions</a></li><li data-nav-id=/6-patching-controls-ssm/4-set-patch-baselines.html title="Set patch baselines" class=dd-item><a href=../6-patching-controls-ssm/4-set-patch-baselines.html><b>4. </b>Set patch baselines</a></li><li data-nav-id=/6-patching-controls-ssm/5-review-compliance.html title="Review compliance" class=dd-item><a href=../6-patching-controls-ssm/5-review-compliance.html><b>5. </b>Review compliance</a></li><li data-nav-id=/6-patching-controls-ssm/6-maintenance-window.html title="Create a maintenance window" class=dd-item><a href=../6-patching-controls-ssm/6-maintenance-window.html><b>6. </b>Create a maintenance window</a></li><li data-nav-id=/6-patching-controls-ssm/7-patch-manager-config.html title="Create Patch Manager configuration" class=dd-item><a href=../6-patching-controls-ssm/7-patch-manager-config.html><b>7. </b>Create Patch Manager configuration</a></li><li data-nav-id=/6-patching-controls-ssm/8-patch-now.html title="Patch Now" class=dd-item><a href=../6-patching-controls-ssm/8-patch-now.html><b>8. </b>Patch Now</a></li><li data-nav-id=/6-patching-controls-ssm/9-clean-up.html title="Clean up" class=dd-item><a href=../6-patching-controls-ssm/9-clean-up.html><b>9. </b>Clean up</a></li></ul></li><li data-nav-id=/7-preventative-controls-codepipeline.html title="Preventative controls with Code Pipeline" class="dd-item
parent"><a href=../7-preventative-controls-codepipeline.html>Preventative controls with Code Pipeline</a><ul><li data-nav-id=/7-preventative-controls-codepipeline/1-intro.html title=Introduction class=dd-item><a href=../7-preventative-controls-codepipeline/1-intro.html><b>1. </b>Introduction</a></li><li data-nav-id=/7-preventative-controls-codepipeline/3-create-environments.html title="Create environments" class=dd-item><a href=../7-preventative-controls-codepipeline/3-create-environments.html><b>3. </b>Create environments</a></li><li data-nav-id=/7-preventative-controls-codepipeline/4-failed-step.html title="Identify failed resource" class=dd-item><a href=../7-preventative-controls-codepipeline/4-failed-step.html><b>3. </b>Identify failed resource</a></li><li data-nav-id=/7-preventative-controls-codepipeline/5-review-checks.html title="Review checks" class=dd-item><a href=../7-preventative-controls-codepipeline/5-review-checks.html><b>5. </b>Review checks</a></li><li data-nav-id=/7-preventative-controls-codepipeline/6-correct-cfn.html title="Review code pipeline" class="dd-item
parent
active"><a href=../7-preventative-controls-codepipeline/6-correct-cfn.html><b>6. </b>Review code pipeline</a></li><li data-nav-id=/7-preventative-controls-codepipeline/7-check-change.html title="Deploy change" class=dd-item><a href=../7-preventative-controls-codepipeline/7-check-change.html><b>7. </b>Deploy change</a></li><li data-nav-id=/7-preventative-controls-codepipeline/10-clean-up.html title="Clean up" class=dd-item><a href=../7-preventative-controls-codepipeline/10-clean-up.html><b>10. </b>Clean up</a></li></ul></li></ul><section id=footer><left><a href="https://aws.amazon.com/privacy/?nc1=f_pr">Privacy</a> | <a href="https://aws.amazon.com/terms/?nc1=f_pr">Site Terms</a> | Â© 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.</left></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=https://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fa fa-bars"></i></a></span><span class=links><a href=../>Risk & Compliance Workshop</a> > <a href=../7-preventative-controls-codepipeline.html>Preventative controls with Code Pipeline</a> > Review code pipeline</span></div></div></div><div id=body-inner><h1>Review code pipeline</h1><p>Go to <strong>Services</strong> and select CodePipeline under <strong>Developer Tools</strong></p><p>Okay, time to get your hands dirty. The Cloud Engineering Team have set you a challenge - correct
the CloudFormation Template so it passes all the rules and deploys.
Recall that it is the S3 bucket with the prefix S3BucketOperations that has failed and the rules that failed are:
W35 - S3 Bucket should have access logging configured,
W41 - S3 Bucket should have encryption option set, and
W51 - S3 bucket should likely have a bucket policy.</p><p>In the S3 Bucket with the name prefix &ldquo;anycompany-cfn-templates-&rdquo;, is folder called
&ldquo;preventative-controls-pipeline&rdquo; and within that is the cfn-template.yaml.zip which contains the
CloudFormation Template you will need to edit.</p><p><strong>NOTE:</strong> To help you along the way the cfn-template.yaml file
includes the script for the Payroll bucket which works and plenty of comments. These begin with the &lsquo;#&rsquo; character and anything to the right of it is a comment. The other thing you <strong>MUST</strong> take note of is indentation. This file uses two spaces for each indent level and you must follow the same indentation as the payroll bucket.</p><p>To edit the CloudFormation Template you don&rsquo;t need anything fancy, however there are plenty of free
code editor you could use. They do make life easier by providing line numbers, indentation guides and formatting your code with colour but TextEdit on Mac or Notepad on Windows will do.</p><h2 id=your-task>Your Task</h2><p>Update the cfn-template.yaml, zip it up, and replace cfn-template.yaml.zip in the S3 bucket. Once this is done the pipeline will run automatically and if you new template is correct the S3 buckets will deploy.</p><ol><li><p><strong>Download the CloudFormation File</strong><br>Go to the S3 bucket with the name that starts with &ldquo;anycompany-cfn-templates&rdquo;, open the folder called &ldquo;preventative-controls-pipeline&rdquo; and within that is the cfn-template.yaml.zip which contains the CloudFormation Template you will need to edit. Download this zip file to a working directory on your computer.</p></li><li><p><strong>Edit the CloudFormation File</strong><br>Unzip the file, open it with an editor and update the file to look like the below. Basically all you need to do is a copy and paste of properties section from the S3BucketPayroll bucket to the S3BucketOperations bucket and then change references to the bucket name in a few places.<br>Make sure you save the changes to the cfn-template.yaml file, don&rsquo;t change the name.</p></li></ol><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>AWSTemplateFormatVersion</span>: <span style=color:#e6db74>2010-09-09</span>
<span style=color:#f92672>Description</span>: <span style=color:#ae81ff>Risk Jam - Preventative Controls</span>

<span style=color:#f92672>Parameters</span>:
  <span style=color:#f92672>S3AccessLoggingBucket</span>:
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>String</span>

<span style=color:#f92672>Resources</span>:

  <span style=color:#75715e>############################################################################</span>
  <span style=color:#75715e># Payroll Department S3 Bucket</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># This bucket configuration includes encryption, access logging, </span>
  <span style=color:#75715e># and a bucket policy which restricts access.</span>
  <span style=color:#75715e>############################################################################</span>

  <span style=color:#f92672>PayrollRole</span>: <span style=color:#75715e># Name of the role - should match the business unit</span>
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::Role</span>
    <span style=color:#f92672>Properties</span>:
      <span style=color:#f92672>AssumeRolePolicyDocument</span>:
        <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#39;2012-10-17&#39;</span>
        <span style=color:#f92672>Statement</span>:
        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
          <span style=color:#f92672>Principal</span>:
            <span style=color:#f92672>AWS</span>: !<span style=color:#ae81ff>Sub arn:aws:iam::${AWS::AccountId}:root</span>
          <span style=color:#f92672>Action</span>:
          - <span style=color:#ae81ff>sts:AssumeRole</span>
 
  <span style=color:#f92672>PayrollBucketPolicy</span>: <span style=color:#75715e># Name of the bucket policy - should match the business unit</span>
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::S3::BucketPolicy</span>
    <span style=color:#f92672>Properties</span>:
      <span style=color:#f92672>Bucket</span>:
        <span style=color:#f92672>Ref</span>: <span style=color:#ae81ff>S3BucketPayroll</span> <span style=color:#75715e># MUST MATCH BUCKET NAME</span>
      <span style=color:#f92672>PolicyDocument</span>:
        <span style=color:#f92672>Statement</span>:
          - <span style=color:#f92672>Action</span>:
              - <span style=color:#ae81ff>s3:GetObject</span>
            <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
            <span style=color:#f92672>Resource</span>: !<span style=color:#ae81ff>Sub &#39;${S3BucketPayroll.Arn}/*&#39;</span> <span style=color:#75715e># MUST MATCH BUCKET NAME - DON&#39;T CHANGE ANYTHING ELSE </span>
            <span style=color:#f92672>Principal</span>: 
              <span style=color:#f92672>AWS</span>:
              - !<span style=color:#ae81ff>GetAtt PayrollRole.Arn</span> <span style=color:#75715e># MUST MATCH BUCKET NAME - DON&#39;T CHANGE ANYTHING ELSE</span>

  <span style=color:#f92672>S3BucketPayroll</span>: <span style=color:#75715e># Name of the S3 bucket resource - should match the business unit</span>
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::S3::Bucket</span>
    <span style=color:#f92672>Properties</span>:
      <span style=color:#f92672>BucketEncryption</span>: 
        <span style=color:#f92672>ServerSideEncryptionConfiguration</span>:
          - <span style=color:#f92672>ServerSideEncryptionByDefault</span>:
              <span style=color:#f92672>SSEAlgorithm</span>: <span style=color:#ae81ff>AES256</span>
      <span style=color:#f92672>LoggingConfiguration</span>:
        <span style=color:#f92672>DestinationBucketName</span>: !<span style=color:#ae81ff>Ref S3AccessLoggingBucket</span>
        <span style=color:#f92672>LogFilePrefix</span>: <span style=color:#ae81ff>payroll-logs</span> <span style=color:#75715e># update to match business unit</span>

  <span style=color:#75715e>############################################################################</span>
  <span style=color:#75715e># Operations Department S3 Bucket</span>
  <span style=color:#75715e>#</span>
  <span style=color:#75715e># This bucket configuration includes encryption, access logging, </span>
  <span style=color:#75715e># and a bucket policy which restricts access.</span>
  <span style=color:#75715e>############################################################################</span>
  
  <span style=color:#f92672>OperationsRole</span>: <span style=color:#75715e># Name of the role - should match the business unit</span>
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::IAM::Role</span>
    <span style=color:#f92672>Properties</span>:
      <span style=color:#f92672>AssumeRolePolicyDocument</span>:
        <span style=color:#f92672>Version</span>: <span style=color:#e6db74>&#39;2012-10-17&#39;</span>
        <span style=color:#f92672>Statement</span>:
        - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
          <span style=color:#f92672>Principal</span>:
            <span style=color:#f92672>AWS</span>: !<span style=color:#ae81ff>Sub arn:aws:iam::${AWS::AccountId}:root</span>
          <span style=color:#f92672>Action</span>:
          - <span style=color:#ae81ff>sts:AssumeRole</span>

  <span style=color:#f92672>OperationsBucketPolicy</span>: <span style=color:#75715e># Name of the bucket policy - should match the business unit</span>
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::S3::BucketPolicy</span>
    <span style=color:#f92672>Properties</span>:
      <span style=color:#f92672>Bucket</span>:
        <span style=color:#f92672>Ref</span>: <span style=color:#ae81ff>S3BucketOperations</span> <span style=color:#75715e># MUST MATCH BUCKET NAME</span>
      <span style=color:#f92672>PolicyDocument</span>:
        <span style=color:#f92672>Statement</span>:
          - <span style=color:#f92672>Action</span>:
              - <span style=color:#ae81ff>s3:GetObject</span>
            <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
            <span style=color:#f92672>Resource</span>: !<span style=color:#ae81ff>Sub &#39;${S3BucketOperations.Arn}/*&#39;</span> <span style=color:#75715e># MUST MATCH BUCKET NAME - DON&#39;T CHANGE ANYTHING ELSE </span>
            <span style=color:#f92672>Principal</span>: 
              <span style=color:#f92672>AWS</span>:
              - !<span style=color:#ae81ff>GetAtt OperationsRole.Arn</span> <span style=color:#75715e># MUST MATCH BUCKET NAME - DON&#39;T CHANGE ANYTHING ELSE</span>

  <span style=color:#f92672>S3BucketOperations</span>: <span style=color:#75715e># This is the name of the bucket resource</span>
    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::S3::Bucket</span>
    <span style=color:#f92672>Properties</span>:
      <span style=color:#f92672>BucketEncryption</span>: 
        <span style=color:#f92672>ServerSideEncryptionConfiguration</span>:
          - <span style=color:#f92672>ServerSideEncryptionByDefault</span>:
              <span style=color:#f92672>SSEAlgorithm</span>: <span style=color:#ae81ff>AES256</span>
      <span style=color:#f92672>LoggingConfiguration</span>:
        <span style=color:#f92672>DestinationBucketName</span>: !<span style=color:#ae81ff>Ref S3AccessLoggingBucket</span>
        <span style=color:#f92672>LogFilePrefix</span>: <span style=color:#ae81ff>operations-logs</span> <span style=color:#75715e># update to match business unit</span>
</code></pre></div><ol start=3><li><p><strong>Zip the file</strong><br>Zip up the cfn-template.yaml file into a new version of cfn-template.yaml.zip - make sure you use this exact file name.</p></li><li><p><strong>Upload the file to S3</strong><br>Upload the new cfn-template.yaml.zip file to the S3 &ldquo;anycompany-cfn-templates&rdquo; bucket, replacing the old file. Make sure that the file is in the &ldquo;preventative-controls-pipeline&rdquo; folder and replaces the old version.</p></li><li><p><strong>Check the Pipeline</strong><br>You can head back to the pipeline to see it pick up the new CloudFormation file and run it through the pipeline.</p></li></ol><p><img src=codepipeline.png alt="Stack create_complete"></p><p>Note that under &ldquo;Most recent execution&rdquo; nothing is shown. This is because we haven&rsquo;t yet provided a change for our code pipeline to process.</p><p>Click on the name of your pipeline to see the stages.</p><p><img src=codepipeline-stages.png alt="Stack create_complete"></p><p>Again, note that the first stage has
<span style=display:inline;font-weight:700;color:red>Failed</span>, but don&rsquo;t worry it is only because the code pipeline tried to run when it is first provisioned but there was no file for it to process. We&rsquo;ll provide a file soon.</p><p>You should have also received and email titled &ldquo;AWS Notifications&rdquo;, this was generated by the pipeline and will require you to confirm your subscription, which you should do now.</p><p>Congratulations, you now have a functioning code pipeline! Now lets try it out.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=../7-preventative-controls-codepipeline/5-review-checks.html title="Review checks"><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=../7-preventative-controls-codepipeline/7-check-change.html title="Deploy change" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=../js/clipboard.min.js></script><script src=../js/perfect-scrollbar.min.js></script><script src=../js/perfect-scrollbar.jquery.min.js></script><script src=../js/jquery.sticky.js></script><script src=../js/featherlight.min.js></script><script src=../js/html5shiv-printshiv.min.js></script><script src=../js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script src=../js/modernizr.custom-3.6.0.js></script><script src=../js/learn.js></script><script src=../js/hugo-learn.js></script><link href=../mermaid/mermaid.css rel=stylesheet><script src=../mermaid/mermaid.js></script><script>mermaid.initialize({startOnLoad:true});</script></body></html>